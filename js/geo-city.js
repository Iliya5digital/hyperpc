jQuery(function($){JBZoo.widget('HyperPC.Geo.City',{'dadataApiKey':''},{autocompleteTimer:undefined,init:function($this){$this._subscribeGeoEvents($this);const dadataApiKey=$this.getOption('dadataApiKey');$this._defineUserLocation($this,dadataApiKey);$this.$('.jsGeoCityInput').suggestions({token:dadataApiKey,type:'ADDRESS',geoLocation:false,bounds:"city-settlement",addon:'none',minChars:3,constraints:{locations:{country:"*"}},onSelect:$this._suggestionSelect,onSuggestionsFetch:$this._suggestionFetch});},_suggestionFetch:function(suggestions){return suggestions.filter(function(suggestion){const isCrimeaRegion=/^(крым$|респ.* крым$|севастополь$)/i.test(suggestion.data.region)||/^(севастополь)$/i.test(suggestion.data.city);return!/^(снт|гск|мкр|тер)/i.test(suggestion.data.settlement_type)&&!(isCrimeaRegion&&suggestion.data.country==='Украина');});},_suggestionSelect:function(suggestion,changed){const $this=$(this).closest('[data-widgetid]').data('HyperPCGeoCity');const userLocation=$this._getUserLocation($this);if(userLocation.location!==suggestion.unrestricted_value){const locationData=suggestion.data;userLocation.country=locationData.country
userLocation.city=locationData.settlement||locationData.city;userLocation.location=suggestion.unrestricted_value;userLocation.fiasId=locationData.fias_id;userLocation.geoId=0;userLocation.zipCode=locationData.postal_code
if(locationData.fias_id===locationData.city_fias_id){userLocation.fiasType='city';}else if(locationData.fias_id===locationData.settlement_fias_id){userLocation.fiasType='settlement';}$('.jsCityLabel').html(userLocation.city);if(locationData.country==='Россия'){$this._getYandexAutocomplete(suggestion.unrestricted_value).done(function(response){if(response.result){const locations=response.body;if(locations.length){userLocation.geoId=locations[0].geoId;}}else{}$this._saveUserLocation($this,userLocation);}).fail(function(error){$this._saveUserLocation($this,userLocation);});}else{$this._saveUserLocation($this,userLocation);}}$this._hideCityModal($(this));$this.$('.jsGeoCityInput').val('');},_onLocationDefined:function(){this._updateCityLabel(this);},_updateCityLabel:function($this){const userLocation=$this._getUserLocation($this);$this.$('.jsCityLabel').html(userLocation.city);if(userLocation.location!==userLocation.city){$this.$('.jsCityLabel').attr('title',userLocation.location);}else{$this.$('.jsCityLabel').removeAttr('title');}},_hideCityModal:function($initializer){const $modal=$initializer.closest('[data-uk-drop], [data-uk-modal]');if($modal.is('[data-uk-drop]')){UIkit.drop($modal).hide(false);}else if($modal.is('[data-uk-modal]')){UIkit.modal($modal).hide();UIkit.offcanvas('#hp-offcanvas-menu').show();}},'click [data-geoid]':function(e,$this){const $city=$(this);const userLocation=$this._getUserLocation($this);if(userLocation.geoId!=$city.data('geoid')){userLocation.country='Россия';userLocation.city=$city.text();userLocation.location=$city.text();userLocation.fiasId=$city.data('fias-id');userLocation.fiasType='city';userLocation.geoId=$city.data('geoid');userLocation.zipCode='';$this._saveUserLocation($this,userLocation);}$this._hideCityModal($city);$this.$('.jsGeoCityInput').val('');}});});